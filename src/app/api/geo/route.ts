import { NextRequest, NextResponse } from 'next/server';

const countryNames: Record<string, string> = {
  'RU': 'Ğ Ğ¾ÑÑĞ¸Ñ', 'UA': 'Ğ£ĞºÑ€Ğ°Ğ¸Ğ½Ğ°', 'US': 'Ğ¡Ğ¨Ğ', 'GB': 'Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ',
  'DE': 'Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ', 'FR': 'Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ', 'ES': 'Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ñ', 'IT': 'Ğ˜Ñ‚Ğ°Ğ»Ğ¸Ñ',
  'CN': 'ĞšĞ¸Ñ‚Ğ°Ğ¹', 'JP': 'Ğ¯Ğ¿Ğ¾Ğ½Ğ¸Ñ', 'KR': 'Ğ®Ğ¶Ğ½Ğ°Ñ ĞšĞ¾Ñ€ĞµÑ', 'IN': 'Ğ˜Ğ½Ğ´Ğ¸Ñ',
  'BR': 'Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ', 'MX': 'ĞœĞµĞºÑĞ¸ĞºĞ°', 'CA': 'ĞšĞ°Ğ½Ğ°Ğ´Ğ°', 'AU': 'ĞĞ²ÑÑ‚Ñ€Ğ°Ğ»Ğ¸Ñ',
  'PL': 'ĞŸĞ¾Ğ»ÑŒÑˆĞ°', 'NL': 'ĞĞ¸Ğ´ĞµÑ€Ğ»Ğ°Ğ½Ğ´Ñ‹', 'BE': 'Ğ‘ĞµĞ»ÑŒĞ³Ğ¸Ñ', 'CH': 'Ğ¨Ğ²ĞµĞ¹Ñ†Ğ°Ñ€Ğ¸Ñ',
  'AT': 'ĞĞ²ÑÑ‚Ñ€Ğ¸Ñ', 'SE': 'Ğ¨Ğ²ĞµÑ†Ğ¸Ñ', 'NO': 'ĞĞ¾Ñ€Ğ²ĞµĞ³Ğ¸Ñ', 'DK': 'Ğ”Ğ°Ğ½Ğ¸Ñ',
  'FI': 'Ğ¤Ğ¸Ğ½Ğ»ÑĞ½Ğ´Ğ¸Ñ', 'CZ': 'Ğ§ĞµÑ…Ğ¸Ñ', 'PT': 'ĞŸĞ¾Ñ€Ñ‚ÑƒĞ³Ğ°Ğ»Ğ¸Ñ', 'GR': 'Ğ“Ñ€ĞµÑ†Ğ¸Ñ',
  'TR': 'Ğ¢ÑƒÑ€Ñ†Ğ¸Ñ', 'IL': 'Ğ˜Ğ·Ñ€Ğ°Ğ¸Ğ»ÑŒ', 'AE': 'ĞĞĞ­', 'SA': 'Ğ¡Ğ°ÑƒĞ´Ğ¾Ğ²ÑĞºĞ°Ñ ĞÑ€Ğ°Ğ²Ğ¸Ñ',
  'EG': 'Ğ•Ğ³Ğ¸Ğ¿ĞµÑ‚', 'ZA': 'Ğ®ĞĞ ', 'AR': 'ĞÑ€Ğ³ĞµĞ½Ñ‚Ğ¸Ğ½Ğ°', 'CL': 'Ğ§Ğ¸Ğ»Ğ¸',
  'CO': 'ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ğ¸Ñ', 'PE': 'ĞŸĞµÑ€Ñƒ', 'VE': 'Ğ’ĞµĞ½ĞµÑÑƒÑĞ»Ğ°', 'ID': 'Ğ˜Ğ½Ğ´Ğ¾Ğ½ĞµĞ·Ğ¸Ñ',
  'TH': 'Ğ¢Ğ°Ğ¸Ğ»Ğ°Ğ½Ğ´', 'VN': 'Ğ’ÑŒĞµÑ‚Ğ½Ğ°Ğ¼', 'PH': 'Ğ¤Ğ¸Ğ»Ğ¸Ğ¿Ğ¿Ğ¸Ğ½Ñ‹', 'MY': 'ĞœĞ°Ğ»Ğ°Ğ¹Ğ·Ğ¸Ñ',
  'SG': 'Ğ¡Ğ¸Ğ½Ğ³Ğ°Ğ¿ÑƒÑ€', 'NZ': 'ĞĞ¾Ğ²Ğ°Ñ Ğ—ĞµĞ»Ğ°Ğ½Ğ´Ğ¸Ñ', 'IE': 'Ğ˜Ñ€Ğ»Ğ°Ğ½Ğ´Ğ¸Ñ',
  'KZ': 'ĞšĞ°Ğ·Ğ°Ñ…ÑÑ‚Ğ°Ğ½', 'BY': 'Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑÑŒ', 'UZ': 'Ğ£Ğ·Ğ±ĞµĞºĞ¸ÑÑ‚Ğ°Ğ½', 'GE': 'Ğ“Ñ€ÑƒĞ·Ğ¸Ñ',
  'AM': 'ĞÑ€Ğ¼ĞµĞ½Ğ¸Ñ', 'AZ': 'ĞĞ·ĞµÑ€Ğ±Ğ°Ğ¹Ğ´Ğ¶Ğ°Ğ½', 'MD': 'ĞœĞ¾Ğ»Ğ´Ğ¾Ğ²Ğ°',
  'LT': 'Ğ›Ğ¸Ñ‚Ğ²Ğ°', 'LV': 'Ğ›Ğ°Ñ‚Ğ²Ğ¸Ñ', 'EE': 'Ğ­ÑÑ‚Ğ¾Ğ½Ğ¸Ñ',
};

const countryFlags: Record<string, string> = {
  'RU': 'ğŸ‡·ğŸ‡º', 'UA': 'ğŸ‡ºğŸ‡¦', 'US': 'ğŸ‡ºğŸ‡¸', 'GB': 'ğŸ‡¬ğŸ‡§', 'DE': 'ğŸ‡©ğŸ‡ª',
  'FR': 'ğŸ‡«ğŸ‡·', 'ES': 'ğŸ‡ªğŸ‡¸', 'IT': 'ğŸ‡®ğŸ‡¹', 'CN': 'ğŸ‡¨ğŸ‡³', 'JP': 'ğŸ‡¯ğŸ‡µ',
  'KR': 'ğŸ‡°ğŸ‡·', 'IN': 'ğŸ‡®ğŸ‡³', 'BR': 'ğŸ‡§ğŸ‡·', 'MX': 'ğŸ‡²ğŸ‡½', 'CA': 'ğŸ‡¨ğŸ‡¦',
  'AU': 'ğŸ‡¦ğŸ‡º', 'PL': 'ğŸ‡µğŸ‡±', 'NL': 'ğŸ‡³ğŸ‡±', 'BE': 'ğŸ‡§ğŸ‡ª', 'CH': 'ğŸ‡¨ğŸ‡­',
  'AT': 'ğŸ‡¦ğŸ‡¹', 'SE': 'ğŸ‡¸ğŸ‡ª', 'NO': 'ğŸ‡³ğŸ‡´', 'DK': 'ğŸ‡©ğŸ‡°', 'FI': 'ğŸ‡«ğŸ‡®',
  'CZ': 'ğŸ‡¨ğŸ‡¿', 'PT': 'ğŸ‡µğŸ‡¹', 'GR': 'ğŸ‡¬ğŸ‡·', 'TR': 'ğŸ‡¹ğŸ‡·', 'IL': 'ğŸ‡®ğŸ‡±',
  'AE': 'ğŸ‡¦ğŸ‡ª', 'SA': 'ğŸ‡¸ğŸ‡¦', 'EG': 'ğŸ‡ªğŸ‡¬', 'ZA': 'ğŸ‡¿ğŸ‡¦', 'AR': 'ğŸ‡¦ğŸ‡·',
  'CL': 'ğŸ‡¨ğŸ‡±', 'CO': 'ğŸ‡¨ğŸ‡´', 'PE': 'ğŸ‡µğŸ‡ª', 'VE': 'ğŸ‡»ğŸ‡ª', 'ID': 'ğŸ‡®ğŸ‡©',
  'TH': 'ğŸ‡¹ğŸ‡­', 'VN': 'ğŸ‡»ğŸ‡³', 'PH': 'ğŸ‡µğŸ‡­', 'MY': 'ğŸ‡²ğŸ‡¾', 'SG': 'ğŸ‡¸ğŸ‡¬',
  'NZ': 'ğŸ‡³ğŸ‡¿', 'IE': 'ğŸ‡®ğŸ‡ª', 'KZ': 'ğŸ‡°ğŸ‡¿', 'BY': 'ğŸ‡§ğŸ‡¾', 'UZ': 'ğŸ‡ºğŸ‡¿',
  'GE': 'ğŸ‡¬ğŸ‡ª', 'AM': 'ğŸ‡¦ğŸ‡²', 'AZ': 'ğŸ‡¦ğŸ‡¿', 'MD': 'ğŸ‡²ğŸ‡©', 'LT': 'ğŸ‡±ğŸ‡¹',
  'LV': 'ğŸ‡±ğŸ‡»', 'EE': 'ğŸ‡ªğŸ‡ª',
};

export async function GET(request: NextRequest) {
  // 1. ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ Vercel geo-Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸
  let countryCode = request.headers.get('x-vercel-ip-country') || '';
  let city = request.headers.get('x-vercel-ip-city') || '';
  
  // 2. Fallback Ğ½Ğ° ip-api.com ĞµÑĞ»Ğ¸ Vercel Ğ½Ğµ Ğ´Ğ°Ğ» Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  if (!countryCode) {
    try {
      const ip = request.headers.get('x-forwarded-for')?.split(',')[0] || '';
      if (ip && ip !== '::1' && ip !== '127.0.0.1') {
        const res = await fetch(`http://ip-api.com/json/${ip}?fields=countryCode,city`);
        if (res.ok) {
          const data = await res.json();
          countryCode = data.countryCode || '';
          city = data.city || '';
        }
      }
    } catch (e) {
      console.error('Geo fallback error:', e);
    }
  }

  const countryName = countryNames[countryCode] || 'Ğ”Ñ€ÑƒĞ³Ğ°Ñ';
  const flag = countryFlags[countryCode] || 'ğŸŒ';

  return NextResponse.json({
    countryCode,
    countryName,
    city: decodeURIComponent(city),
    flag,
    detected: !!countryCode
  });
}
