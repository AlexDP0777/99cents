// Prisma schema for 99 Cents project

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Участник (идентифицируется по кошельку или уникальному токену)
model Participant {
  id            String    @id @default(cuid())
  walletAddress String?   @unique
  tokenId       String?   @unique  // для фиат-платежей через Stripe
  country       String?
  city          String?
  latitude      Float?
  longitude     Float?
  canVote       Boolean   @default(false)
  lastVoteDate  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  payments      Payment[]
  votes         Vote[]
}

// Платёж
model Payment {
  id            String   @id @default(cuid())
  participantId String
  amount        Float    @default(0.99)
  currency      String   @default("USD")
  paymentType   String   // "USDC" или "STRIPE"
  txHash        String?  // хеш транзакции для блокчейна
  stripeId      String?  // ID платежа Stripe
  status        String   @default("pending") // pending, completed, failed
  createdAt     DateTime @default(now())

  participant   Participant @relation(fields: [participantId], references: [id])
}

// Проект для голосования
model Project {
  id          String   @id @default(cuid())
  title       String
  description String
  imageUrl    String?
  targetAmount Float?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  votes       Vote[]
}

// Голос
model Vote {
  id            String   @id @default(cuid())
  participantId String
  projectId     String
  createdAt     DateTime @default(now())

  participant   Participant @relation(fields: [participantId], references: [id])
  project       Project     @relation(fields: [projectId], references: [id])

  @@unique([participantId, projectId, createdAt])
}

// Период голосования
model VotingPeriod {
  id        String   @id @default(cuid())
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)
  winnerId  String?  // ID победившего проекта
  createdAt DateTime @default(now())
}

// Глобальная статистика (кеш)
model Stats {
  id               String   @id @default("global")
  totalParticipants Int     @default(0)
  totalCountries    Int     @default(0)
  totalAmount       Float   @default(0)
  updatedAt         DateTime @updatedAt
}
